<!DOCTYPE html>
<html>

	<head>
		<title>Strecke messen</title>
		<meta charset="UTF-8"/>
		<meta name="description" content="Strecke messen auf einer Karte. Vermessen sie ihre Strecken über diese Onlineanwendung. Ob Laufstrecken, Radstrecken oder was auch immer. Die Anwendung gibt ihnen die Länge aus."/>

		<link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
		<link rel="stylesheet" href="vendor/bootstrap-4.1.1-dist/css/bootstrap.min.css" type="text/css">
		<link rel="stylesheet" href="css/main.css" type="text/css">

		<!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
		<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
		<script src="https://openlayers.org/en/v4.6.5/build/ol-debug.js"></script>
		<script src="vendor/bootstrap-4.1.1-dist/js/bootstrap.min.js"></script>
		<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
		<script src="js/script.js"></script>


	</head>

	<body>
		<noscript>
<!-- Matomo Image Tracker-->
<img src="http://noppelmax.online/piwik/piwik.php?idsite=1&amp;rec=1" style="border:0" alt="" />
<!-- End Matomo -->
		</noscript>

		<div id="menu">
			<!--p>
		 <a href="index.html">Download GPX Track (Not implemented yet)</a>,
		 <a href="index.html">new path (not implemented yet)</a>,
		 <input type="checkbox">Roundtrip (not implemented yet)</input>
		 </p-->
		 <p>
		 <div class="alertbox">
			 <div class="infoalert alert alert-info" role="alert">
				 Beende deinen Track und selektiere ihn um in den Bearbeitenmodus überzugehen.
			 </div>
			 <div class="infoalert alert alert-info" role="alert">
				 Drück Backspace um den letzten Punkt zu löschen.
			 </div>
		 </div>

		 </p>
		 <h1>streckemessen.de</h1>
		 <p>
		 <button class="location btn btn-secondary" data-name="Berlin" data-center="13.406485,52.518444" data-zoom="12">Berlin</button>
		 <button class="location btn btn-secondary" data-name="Hamburg" data-center="10.004692,53.540295" data-zoom="12">Hamburg</button>
		 <button class="location btn btn-secondary" data-name="München" data-center="11.554186,48.143373" data-zoom="12">München</button>
		 <button class="location btn btn-secondary" data-name="Karlsruhe" data-center="8.401285,48.999550" data-zoom="12">Karlsruhe</button>
		 <!--form id="searchForm" style="display: inline;"-->
		 <input type="text" id="searchText" onenter="search()" aria-describedby="searchtext" placeholder="Berlin"></input>
		 <button type="button" class="btn btn-primary" onclick="search()">Search</button>
		 <button class="btn btn-secondary" onclick="window.location.href='help.html'">?</button>
		 <!--/form-->
		 </p>
		</div>
		<div id="map" class="map"></div>
		<div id="footer">
			MIT Licence 2018, Maximilian Noppel | Version
			<span id="version">loading</span> |
			<a href="issues.html">Issues</a> |
			<a href="impressum.html">Impressum</a> | Kartendaten: ©
			<a href="https://www.openstreetmap.org/">OpenStreetMap</a> (
			<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)
		</div>
		<script>
//$('#searchForm').on("submit", function (e) {
//    console.log("Submitted");
//    e.preventDefault();
//    search();
//});

function search() {
	searchText = document.getElementById("searchText").value;
	searchForText(searchText);
}

function searchForText(searchText) {
	console.log("searching for: ", searchText);

	$.getJSON("https://nominatim.openstreetmap.org/search?q=" + searchText + "&format=json&countrycodes=de,ch,fr", function (json) {
		var txt = "" + json[0].lon + "," + json[0].lat + "";
		console.log(txt);

		var view = map.getView();
		view.setCenter(ol.proj.fromLonLat(txt.split(',').map(Number)));
		view.setZoom(12);
	});
}

var raster = new ol.layer.Tile({
	source: new ol.source.OSM()
});

var source = new ol.source.Vector();




var styleFinished = [
	new ol.style.Style({
		fill: new ol.style.Fill({
			color: 'rgba(255, 255, 255, 0)'
		}),
		stroke: new ol.style.Stroke({
			color: '#0267fd',
			width: 3
		}),
		image: new ol.style.Circle({
			radius: 7,
			fill: new ol.style.Fill({
				color: '#0267fd'
			})
		})
	}),
	new ol.style.Style({
		image: new ol.style.Circle({
			radius: 4,
			fill: new ol.style.Fill({
				color: '#0267fd'
			})
		}),
		geometry: function (feature) {
			// return the coordinates of the first ring of the polygon
			var coordinates = feature.getGeometry().getCoordinates();
			return new ol.geom.MultiPoint(coordinates);
		}
	})
];

var vector = new ol.layer.Vector({
	source: source,
	style: styleFinished,
	wrapX: false
});

var select = new ol.interaction.Select({
	wrapX: false
});

var modify = new ol.interaction.Modify({
	features: select.getFeatures()
})


/**
 * Currently drawn feature.
 * @type {ol.Feature}
 */
var sketch;


/**
 * The help tooltip element.
 * @type {Element}
 */
var helpTooltipElement;


/**
 * Overlay to show the help messages.
 * @type {ol.Overlay}
 */
var helpTooltip;


/**
 * The measure tooltip element.
 * @type {Element}
 */
var measureTooltipElement;


/**
 * Overlay to show the measurement.
 * @type {ol.Overlay}
 */
var measureTooltip;


/**
 * Message to show when the user is drawing a line.
 * @type {string}
 */
var continueLineMsg = 'Click to continue drawing the line';


/**
 * Handle pointer move.
 * @param {ol.MapBrowserEvent} evt The event.
 */
var pointerMoveHandler = function (evt) {
	if (evt.dragging) {
		return;
	}
	/** @type {string} */
	var helpMsg = 'Click to start drawing';

	if (sketch) {
		helpMsg = continueLineMsg;
	}

	helpTooltipElement.innerHTML = helpMsg;
	helpTooltip.setPosition(evt.coordinate);

	helpTooltipElement.classList.remove('hidden');
};


var map = new ol.Map({
	layers: [raster, vector],
	target: 'map',
	view: new ol.View({
		center: [8.401285, 48.999550],
		zoom: 12
	}),
	controls: ol.control.defaults({
		attribution: false,
		zoom: false,
	})
});

map.on('pointermove', pointerMoveHandler);


map.getViewport().addEventListener('mouseout', function () {
	helpTooltipElement.classList.add('hidden');
});

var draw; // global so we can remove it later

setTimeout(function () {
	$('.infoalert').remove();
}, 10000);

/**
 * Format length output.
 * @param {ol.geom.LineString} line The line.
 * @return {string} The formatted length.
 */
var formatLength = function (line) {
	var length = ol.Sphere.getLength(line);
	var output;
	if (length > 100) {
		output = (Math.round(length / 1000 * 100) / 100) +
			' ' + 'km';
	} else {
		output = (Math.round(length * 100) / 100) +
			' ' + 'm';
	}
	return output;
};


var styleDrawing = [
	new ol.style.Style({
		fill: new ol.style.Fill({
			color: 'rgba(255, 255, 255, 0.2)'
		}),
		stroke: new ol.style.Stroke({
			color: '#0267fd',
			lineDash: [10, 10],
			width: 3
		}),
		image: new ol.style.Circle({
			radius: 5,
			stroke: new ol.style.Stroke({
				color: '#0267fd'
			}),
			fill: new ol.style.Fill({
				color: 'rgba(255, 255, 255, 0.2)'
			})
		})
	}),
	new ol.style.Style({
		image: new ol.style.Circle({
			radius: 4,
			fill: new ol.style.Fill({
				color: '#0267fd'
			})
		}),
		geometry: function (feature) {
			// return the coordinates of the first ring of the polygon
			var coordinates = feature.getGeometry().getCoordinates();
			return new ol.geom.MultiPoint(coordinates);
		}
	})
];

var draw;

function addInteraction() {
	var type = 'LineString';
	draw = new ol.interaction.Draw({
		source: source,
		type: type,
		style: styleDrawing
	});
	map.addInteraction(draw);

	createMeasureTooltip();
	createHelpTooltip();

	var drawListener;
	var modifyListener;
	draw.on('drawstart',
			function (evt) {
				$('.infoalert').remove();

				// set sketch
				sketch = evt.feature;

				/** @type {ol.Coordinate|undefined} */
				var tooltipCoord = evt.coordinate;

				drawListener = sketch.getGeometry().on('change', function (evt) {
					var geom = evt.target;
					var output = formatLength(geom);
					tooltipCoord = geom.getLastCoordinate();

					measureTooltipElement.innerHTML = output;
					measureTooltip.setPosition(tooltipCoord);
				});
			}, this);

	draw.on('drawend',
			function (evt) {
				measureTooltipElement.className = 'tooltip tooltip-static';
				measureTooltip.setOffset([0, -7]);

				/* Disable drawing more than one LineString */
				map.removeInteraction(draw);
				helpTooltipElement.remove();
				map.addInteraction(select);
				map.addInteraction(modify);
				//select.getFeatures().push(evt.features);
			}, this);
}

document.addEventListener('keydown', function (e) {
	if (e.which == 8)
		draw.removeLastPoint()
});





/**
 * Creates a new help tooltip
 */
function createHelpTooltip() {
	if (helpTooltipElement) {
		helpTooltipElement.parentNode.removeChild(helpTooltipElement);
	}
	helpTooltipElement = document.createElement('div');
	helpTooltipElement.className = 'tooltip tooltip-help hidden';
	helpTooltip = new ol.Overlay({
		element: helpTooltipElement,
		offset: [15, 0],
		positioning: 'center-left'
	});
	map.addOverlay(helpTooltip);
}


/**
 * Creates a new measure tooltip
 */
function createMeasureTooltip() {
	if (measureTooltipElement) {
		measureTooltipElement.parentNode.removeChild(measureTooltipElement);
	}
	measureTooltipElement = document.createElement('div');
	measureTooltipElement.className = 'tooltip tooltip-measure';
	measureTooltip = new ol.Overlay({
		element: measureTooltipElement,
		offset: [0, -15],
		positioning: 'bottom-center'
	});
	map.addOverlay(measureTooltip);
}

var locations = document.getElementsByClassName('location');
for (var i = 0, ii = locations.length; i < ii; ++i) {
			locations[i].addEventListener('click', relocate);
			}

			function relocate(event) {
			var data = event.target.dataset;
			searchForText(data.name);
			}

			/* Go to default view */
			searchForText("Karlsruhe");
			map.getView().setZoom(Number(13));

			goToLocation();

			addInteraction();
			loadVersion();


		</script>
		<!-- Matomo -->
		<script type="text/javascript">
			var _paq = _paq || [];
			/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
			_paq.push(['trackPageView']);
			_paq.push(['enableLinkTracking']);
			(function() {
				var u="http://noppelmax.online/piwik/";
				_paq.push(['setTrackerUrl', u+'piwik.php']);
				_paq.push(['setSiteId', '1']);
				var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
				g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
			})();
		</script>
		<!-- End Matomo Code -->
	</body>

</html>
